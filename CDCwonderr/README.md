<!-- README.md is generated from README.Rmd. Please edit that file -->
CDCwonderr
==========

The extra 'r' is for the language.

Motivation
----------

My team at the JHU DaSH wanted to correlate statistics regarding lead poisoning with mental health problems or general "malfeasance". What we settled upon was to use statistics of suicides/homicides committed, with [this dataset](ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/Datasets/DATA2010/State_data_tables/).

However, we found that there were discrepancies between some xls and csv files that were supposed to contain the same data. Moreover, we encountered some difficulties in interpreting/comparing between some of the demographics included, and not all of those demographic categories were included for each focus condition of a spreadsheet, or even between spreadsheets.

To achieve our end goal, then, we needed to: - parse the data from the original xls files to preserve data integrity/quality - be able to select certain demographics for which we could extract statistics of interest

In the end, we managed to write some functions to simultaneously accomplish these goals, and decided to bundle them up in a package so that perhaps it would be useful to others. For our end product, see the Shiny presentation in this repo.

Example
-------

``` r
suppressPackageStartupMessages({
  library(devtools)
  library(readxl)
  library(readxl)
})  
dev_mode()
#> Dev mode: OFF
library(dplyr, warn = F)

# all the xls files have the first line data-free
suici <- read_excel("data-raw/NFOCUS18ST.XLS", skip = 1)
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00 
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00 
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00 
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00
suici %>% glimpse
#> Observations: 1,863
#> Variables: 34
#> $        Objective                                        (chr) "     ...
#> $ 1998                                                    (chr) "    "...
#> $ Raw                                                     (chr) "   ",...
#> $ error                                                   (chr) "  ", ...
#> $ 1999                                                    (chr) "    "...
#> $ Raw                                                     (chr) "    "...
#> $ error                                                   (chr) "    "...
#> $ 2000                                                    (chr) "    "...
#> $ Raw                                                     (chr) "    "...
#> $ error                                                   (chr) "    "...
#> $ 2001                                                    (chr) "    "...
#> $ Raw                                                     (chr) "     ...
#> $ error                                                   (chr) "    "...
#> $ 2002                                                    (chr) "    "...
#> $ Raw                                                     (chr) "    "...
#> $ error                                                   (chr) "    "...
#> $ 2003                                                    (chr) "    "...
#> $ Raw                                                     (chr) "    "...
#> $ error                                                   (chr) "    "...
#> $ 2004                                                    (chr) "    "...
#> $ Raw                                                     (chr) "    "...
#> $ error                                                   (chr) "    "...
#> $ 2005                                                    (chr) "    "...
#> $ Raw                                                     (chr) "    "...
#> $ error                                                   (chr) "    "...
#> $ 2006                                                    (chr) "    "...
#> $ Raw                                                     (chr) "    "...
#> $ error                                                   (chr) "    "...
#> $ 2007                                                    (chr) "    "...
#> $ Raw                                                     (chr) "   ",...
#> $ error                                                   (chr) "  ", ...
#> $ 2008                                                    (chr) "    "...
#> $ Raw                                                     (chr) "   ",...
#> $ error                                                   (chr) "  ", ...
```

Here, we see that there are a few difficulties. One is that column names are not all distinct. Another is that some have empty spaces (e.g., the "Objective" column); some other files even have empty columns (with footnote numbers in the excel file, which probably aren't useful in an analysis). Also (and you can confirm this yourself), the end of the file doesn't have data we're interested in. To fix these problems, we can use the following functions:

``` r
load_all(".") # load functions in the package
#> Loading CDCwonderr
#> Warning: package 'stringr' was built under R version 3.1.3
#> 
#> Attaching package: 'tidyr'
#> 
#> The following object is masked from 'package:magrittr':
#> 
#>     extract
suici2 <- suici %>% fix_col_names %>% rm_tail
suici2 %>% glimpse
#> Observations: 1,857
#> Variables: 34
#> $ Objective   (chr) "                                                 ...
#> $ 1998rounded (chr) "    ", NA, NA, "---", NA, "---", "---", "---", "-...
#> $ 1998raw     (chr) "   ", NA, NA, ".", NA, ".", ".", ".", ".", ".", "...
#> $ 1998error   (chr) "  ", NA, NA, ".", NA, ".", ".", ".", ".", ".", "....
#> $ 1999rounded (chr) "    ", NA, NA, "12.5", NA, "DSU", "DSU", "DNC", "...
#> $ 1999raw     (chr) "    ", NA, NA, "12.5", NA, "0.0", "2.8", ".", "."...
#> $ 1999error   (chr) "    ", NA, NA, "0.5", NA, "0.0", "2.8", ".", ".",...
#> $ 2000rounded (chr) "    ", NA, NA, "13.1", NA, "DSU", "DSU", "DNA", "...
#> $ 2000raw     (chr) "    ", NA, NA, "13.1", NA, "4.5", "2.2", ".", "."...
#> $ 2000error   (chr) "    ", NA, NA, "0.5", NA, "4.5", "2.2", ".", ".",...
#> $ 2001rounded (chr) "    ", NA, NA, "11.3", NA, "DSU", "DSU", "DNA", "...
#> $ 2001raw     (chr) "     ", NA, NA, "11.3", NA, "0.0", "5.9", ".", "....
#> $ 2001error   (chr) "    ", NA, NA, "0.5", NA, "0.0", "3.4", ".", ".",...
#> $ 2002rounded (chr) "    ", NA, NA, "11.4", NA, "DSU", "DSU", "DNA", "...
#> $ 2002raw     (chr) "    ", NA, NA, "11.4", NA, "10.6", "0.0", ".", "....
#> $ 2002error   (chr) "    ", NA, NA, "0.5", NA, "6.1", "0.0", ".", ".",...
#> $ 2003rounded (chr) "    ", NA, NA, "11.4", NA, "DSU", "DSU", "DNA", "...
#> $ 2003raw     (chr) "    ", NA, NA, "11.4", NA, "0.0", "3.6", ".", "."...
#> $ 2003error   (chr) "    ", NA, NA, "0.5", NA, "0.0", "2.6", ".", ".",...
#> $ 2004rounded (chr) "    ", NA, NA, "11.7", NA, "DSU", "DSU", "DNA", "...
#> $ 2004raw     (chr) "    ", NA, NA, "11.7", NA, "7.0", "20.1", ".", "....
#> $ 2004error   (chr) "    ", NA, NA, "0.5", NA, "5.0", "6.8", ".", ".",...
#> $ 2005rounded (chr) "    ", NA, NA, "11.5", NA, "DSU", "DSU", "DNA", "...
#> $ 2005raw     (chr) "    ", NA, NA, "11.5", NA, "4.3", "4.8", ".", "."...
#> $ 2005error   (chr) "    ", NA, NA, "0.5", NA, "4.3", "3.4", ".", ".",...
#> $ 2006rounded (chr) "    ", NA, NA, "12.4", NA, "DSU", "DSU", "DNA", "...
#> $ 2006raw     (chr) "    ", NA, NA, "12.4", NA, "6.9", "5.4", ".", "."...
#> $ 2006error   (chr) "    ", NA, NA, "0.5", NA, "4.9", "3.2", ".", ".",...
#> $ 2007rounded (chr) "    ", NA, NA, "---", NA, "---", "---", "---", "-...
#> $ 2007raw     (chr) "   ", NA, NA, ".", NA, ".", ".", ".", ".", ".", "...
#> $ 2007error   (chr) "  ", NA, NA, ".", NA, ".", ".", ".", ".", ".", "....
#> $ 2008rounded (chr) "    ", NA, NA, "---", NA, "---", "---", "---", "-...
#> $ 2008raw     (chr) "   ", NA, NA, ".", NA, ".", ".", ".", ".", ".", "...
#> $ 2008error   (chr) "  ", NA, NA, ".", NA, ".", ".", ".", ".", ".", "....
```

The "Objective" column contains state names, names of demographic variables, and health conditions as well. A combination of "add\_FIELD" and "add\_FIELD\_names" functions can be used to add an entire column with values corresponding to the the respective row. For example,

``` r
suici2 %>% 
  add_focus %>% 
  add_focus_name %>%
  add_states %>% 
  add_state_names %>% 
  add_gender %>% 
  filter(gender_row == TRUE) %>% 
  select(-gender_row) %>% 
  glimpse
#> Observations: 204
#> Variables: 38
#> $ Objective   (chr) "               Female", "               Male", " ...
#> $ State       (chr) "Alabama", "Alabama", "Alaska", "Alaska", "Arizona...
#> $ State_row   (lgl) FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, F...
#> $ focus_name  (chr) "18-1    Suicide (age adjusted per 100,000 standar...
#> $ focus_row   (lgl) FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, F...
#> $ 1998rounded (chr) "---", "---", "---", "---", "---", "---", "---", "...
#> $ 1998raw     (chr) ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ...
#> $ 1998error   (chr) ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ...
#> $ 1999rounded (chr) "4.1", "22.0", "8.1", "26.2", "6.6", "25.1", "4.4"...
#> $ 1999raw     (chr) "4.1", "22.0", "8.1", "26.3", "6.6", "25.1", "4.4"...
#> $ 1999error   (chr) "0.4", "1.0", "1.8", "3.9", "0.5", "1.0", "0.6", "...
#> $ 2000rounded (chr) "4.8", "22.8", "7.9", "34.3", "6.2", "25.7", "5.0"...
#> $ 2000raw     (chr) "4.8", "22.8", "7.9", "34.3", "6.2", "25.7", "5.0"...
#> $ 2000error   (chr) "0.5", "1.1", "1.6", "3.4", "0.5", "1.0", "0.6", "...
#> $ 2001rounded (chr) "4.1", "19.7", "6.4", "25.0", "5.6", "24.5", "4.9"...
#> $ 2001raw     (chr) "4.1", "19.7", "6.4", "25.0", "5.6", "24.5", "4.9"...
#> $ 2001error   (chr) "0.4", "1.0", "1.4", "2.9", "0.5", "1.0", "0.6", "...
#> $ 2002rounded (chr) "4.3", "19.9", "10.9", "30.9", "6.3", "27.2", "4.9...
#> $ 2002raw     (chr) "4.3", "19.9", "10.9", "30.9", "6.3", "27.2", "4.9...
#> $ 2002error   (chr) "0.4", "1.0", "1.9", "3.5", "0.5", "1.0", "0.6", "...
#> $ 2003rounded (chr) "4.0", "19.8", "7.5", "33.9", "6.4", "25.0", "5.2"...
#> $ 2003raw     (chr) "4.0", "19.8", "7.5", "33.9", "6.4", "25.0", "5.2"...
#> $ 2003error   (chr) "0.4", "1.0", "1.5", "4.0", "0.5", "1.0", "0.6", "...
#> $ 2004rounded (chr) "4.1", "20.4", "11.5", "34.5", "6.6", "25.3", "4.9...
#> $ 2004raw     (chr) "4.1", "20.4", "11.5", "34.5", "6.6", "25.3", "4.9...
#> $ 2004error   (chr) "0.4", "1.0", "1.9", "3.3", "0.5", "1.0", "0.6", "...
#> $ 2005rounded (chr) "4.0", "20.1", "8.5", "31.7", "6.9", "25.9", "6.0"...
#> $ 2005raw     (chr) "4.0", "20.1", "8.5", "31.7", "6.9", "25.9", "6.0"...
#> $ 2005error   (chr) "0.4", "1.0", "1.7", "3.4", "0.5", "1.0", "0.7", "...
#> $ 2006rounded (chr) "3.9", "22.0", "9.1", "31.1", "6.9", "25.5", "4.4"...
#> $ 2006raw     (chr) "3.9", "22.0", "9.1", "31.1", "6.9", "25.5", "4.4"...
#> $ 2006error   (chr) "0.4", "1.0", "1.6", "3.4", "0.5", "0.9", "0.6", "...
#> $ 2007rounded (chr) "---", "---", "---", "---", "---", "---", "---", "...
#> $ 2007raw     (chr) ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ...
#> $ 2007error   (chr) ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ...
#> $ 2008rounded (chr) "---", "---", "---", "---", "---", "---", "---", "...
#> $ 2008raw     (chr) ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ...
#> $ 2008error   (chr) ".", ".", ".", ".", ".", ".", ".", ".", ".", ".", ...
```

should indicate that the manipulations added a column which contains the state name corresponding to the statistics in each row.

For our purposes, we wrapped up all the functionality to transform a string with the filename, to a tidy dataset ready to incorporate into our analysis, with the get\_gender\_comp function.

``` r
homicides <- get_gender_comp("data-raw/NFOCUS18ST.XLS")
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00 
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00 
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00 
#> DEFINEDNAME: 20 00 00 01 0b 00 00 00 01 00 00 00 00 00 00 07 3b 00 00 01 00 01 00 00 00 ff 00
#> Warning in extract_numeric(c("---", "---", "---", "---", "---", "---",
#> "---", : NAs introduced by coercion
homicides %>% 
  rename(Gender = Objective) %>% 
  mutate(Gender = str_replace_all(Gender, " ", "")) %>% 
  glimpse
#> Observations: 1,116
#> Variables: 7
#> $ Gender     (chr) "Female", "Female", "Female", "Female", "Female", "...
#> $ State      (chr) "Alabama", "Alabama", "Alabama", "Alabama", "Alabam...
#> $ focus_name (chr) "18-1    Suicide (age adjusted per 100,000 standard...
#> $ Year       (chr) "1999", "2000", "2001", "2002", "2003", "2004", "20...
#> $ error      (dbl) 0.4, 0.5, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.7, 0.4, 0...
#> $ raw        (dbl) 4.1, 4.8, 4.1, 4.3, 4.0, 4.1, 4.0, 3.9, 3.5, 2.3, 3...
#> $ rounded    (dbl) 4.1, 4.8, 4.1, 4.3, 4.0, 4.1, 4.0, 3.9, 3.5, 2.3, 3...
```

Acknowledgements
----------------

Thanks to [Sean Davis](http://watson.nci.nih.gov/~sdavis/) for help with the idea and R package development, and [Steve Wells](http://stevenwells.com/) for help with regex expressions.
